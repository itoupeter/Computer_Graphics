<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0041)http://rendering.aspone.cz/BiDirCode.aspx -->
<html xmlns="http://www.w3.org/1999/xhtml"><head id="ctl00_Head1"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>
	Rendering Competition - Bi-Directional Path Tracing
</title><link rel="stylesheet" href="./bidirectional_files/style.css" media="all" type="text/css"></head>
<body>
  <form name="aspnetForm" method="post" action="./bidirectional_files/bidirectional.html" id="aspnetForm">
<div>
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwULLTEwMDUyNjYzMjhkZHCjPK0EndPw4pTwljPOXemWZbt2">
</div>

<div>

	<input type="hidden" name="__VIEWSTATEGENERATOR" id="__VIEWSTATEGENERATOR" value="8644C914">
</div>
  <div id="nav-menu">
    <ul>
    <li id="menuTitle">Rendering Competition<br>Menu</li>    
    <li><a href="http://rendering.aspone.cz/Default.aspx">Main Page</a></li>
    <li><a href="http://rendering.aspone.cz/Galery.aspx">Image Galery</a></li>
    <li><a href="./bidirectional_files/bidirectional.html">Bi-Dir. Path Tracing</a></li>
    <li><a href="http://rendering.aspone.cz/BumpMapCode.aspx">Bump Mapping</a></li>
    <li><a href="http://rendering.aspone.cz/Collisions.aspx">Collisions</a></li>
    <li><a href="http://rendering.aspone.cz/DOFcode.aspx">Depth of Field</a></li>
    <li><a href="http://rendering.aspone.cz/Materials.aspx">Materials</a></li>
    <li><a href="http://rendering.aspone.cz/MotionBlurCode.aspx">Motion Blur</a></li>
    <li><a href="http://rendering.aspone.cz/ProceduralShaders.aspx">Procedural Shaders</a></li> 
    <li><a href="http://rendering.aspone.cz/ImportanceSampling.aspx">Importance Sampling</a></li> 
    <li><a href="http://rendering.aspone.cz/Authors.aspx">About the Authors</a></li>
    </ul>
  </div>
  <div style="position:absolute; top:0; left:170px; width:900px;">
    
  <h1>Bi-Directional Path Tracing</h1><br>
  <p>Bi-Directional Path Tracing is main algorithm used in our renderer instead of Ray Tracing algorithm. Its main advantage is physically correct illumination including indirect lights and caustics. Its disadvantages are noisiness of rendered images and its speed. Our implementation gives sufficient results with 25 samples per pixel for still scene (even 16 is OK), but it needs much more samples for realistic motion blur and DOF without a lot of noise. Note that we have implemented the importance sampling technique which greatly reduces number of samples requiered for rendering less noisy images.</p>
  <img src="./bidirectional_files/Authors.png" alt="Rendered with DOF, 100 samples per pixel" width="800" height="600"><br><br><br>
  <div><span id="SourceCodeTitleSpan">Source code (core part):</span></div>
<div id="divSourceCode"><div id="divSourceCodeInner">
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;">// from Scene.hxx</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp;</span></span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: blue; font-family: &#39;Courier New&#39;;">int</span><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"> GeneratePath(Ray &amp;ray, BidirVertex *vertices, <span style="color: blue">int</span> maxVerts, Scene *scene)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">int</span> nVerts = 0;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">int</span> i;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Ray rayOut;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">while</span> (nVerts &lt; maxVerts) </span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">if</span> (! scene-&gt;Intersect(ray))</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">break</span>;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>BidirVertex &amp;v = vertices[nVerts];</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>v.material = ray.hit-&gt;getMaterial();</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>v.prim = ray.hit;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Vec2f uv = ray.hit-&gt;GetUV(ray);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>v.v = uv.x();</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>v.u = uv.y();</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>v.dirIn = ray.dir;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>v.point = ray.org + ray.dir * ray.t;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>v.normalGeometric = ray.hit-&gt;GetNormal(ray);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>v.normalShading = ray.hit-&gt;GetNormal(ray);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>++nVerts;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">if</span> (nVerts &gt; 2) </span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green">// double prob = RUSSIAN_ROULETTE;</span></span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">if</span> (frand() &gt; RUSSIAN_ROULETTE)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">break</span>;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>v.relativeWeight = 1. / RUSSIAN_ROULETTE;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>v.material-&gt;ReflectRay(ray, rayOut, &amp;v.brdfWeight);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>v.dirOut = rayOut.dir;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ray = rayOut;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">if</span> (v.brdfWeight == 0.f)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">break</span>;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green">// Initialize additional values in vertices</span></span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">for</span> (i = 0; i &lt; nVerts-1; ++i)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>vertices[i].totalWeight = vertices[i].brdfWeight * fabs((Dot(-vertices[i].dirOut, vertices[i+1].normalGeometric) / DistanceSquared(vertices[i].point, vertices[i+1].point)));</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">return</span> nVerts;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">};</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: blue; font-family: &#39;Courier New&#39;;">inline</span><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"> <span style="color: blue">double</span> WeightPath(BidirVertex* <span style="color: green">/*eye*/</span>, <span style="color: blue">int</span> nEye, BidirVertex* <span style="color: green">/*light*/</span>, <span style="color: blue">int</span> nLight) </span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">return</span> <span style="color: blue">double</span>(nEye + nLight);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">};</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">Vec3f EvalPath(Scene *scene, BidirVertex *eye, <span style="color: blue">int</span> nEye, BidirVertex *light, <span style="color: blue">int</span> nLight) </span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Vec3f L(1.);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">int</span> i;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">for</span> ( i = 0; i &lt; nEye-1; ++i)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>L *= eye[i].material-&gt;f(eye[i].dirIn, eye[i].dirOut) * eye[i].material-&gt;GetColor(eye[i].u, eye[i].v, eye[i].point, eye[i].prim) * fabs(Dot(eye[i].dirOut, eye[i].normalGeometric))<span>&nbsp; </span>/ (eye[i].brdfWeight * eye[i].relativeWeight);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Vec3f w = light[nLight-1].point - eye[nEye-1].point;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Vec3f ww = -w;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>L *= eye[nEye-1].material-&gt;f(eye[nEye-1].dirIn, w) * eye[nEye-1].material-&gt;GetColor(eye[nEye-1].u, eye[nEye-1].v, eye[nEye-1].point, eye[nEye-1].prim) * G(eye[nEye-1], light[nLight-1]) * light[nLight-1].material-&gt;f(ww, light[nLight-1].dirIn) / (eye[nEye-1].relativeWeight * light[nLight-1].relativeWeight);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">for</span> ( i = nLight-2; i &gt;= 0; --i)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>L *= light[i].material-&gt;f(light[i].dirIn, light[i].dirOut) * light[i].material-&gt;GetColor(light[i].u, light[i].v, light[i].point, light[i].prim) * fabs(Dot(light[i].dirOut, light[i].normalGeometric)) / (light[i].brdfWeight * light[i].relativeWeight);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">if</span> (L.x() == 0. &amp;&amp; L.y() == 0 &amp;&amp; L.z() == 0)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">return</span> L;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">if</span> (!Visible(scene, eye[nEye-1].point, light[nLight-1].point))</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">return</span> Vec3f(0.);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">return</span> L;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">};</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: blue; font-family: &#39;Courier New&#39;;">bool</span><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"> Visible(Scene *scene, Vec3f &amp;P0,<span>&nbsp; </span>Vec3f &amp;P1)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Ray ray;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ray.org = P0;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ray.dir = P1 - P0;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Normalize(ray.dir);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">return</span> ! scene-&gt;Intersect(ray);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: blue; font-family: &#39;Courier New&#39;;">inline</span><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"> <span style="color: blue">double</span> G(BidirVertex &amp;v0, BidirVertex &amp;v1)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Vec3f w = (v1.point - v0.point);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Normalize(w);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">return</span> fabs(Dot(v0.normalGeometric, w)) * fabs(Dot(v1.normalGeometric, -w)) / DistanceSquared(v0.point, v1.point);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">Vec3f Li(Scene * scene, Ray &amp;ray, Ray lightRay, <span style="color: blue">double</span> lightPdf, <span style="color: blue">double</span> lightWeight) </span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Vec3f L(0.);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">int</span> i,j;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green">// Generate eye and light sub-paths</span></span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>BidirVertex eyePath[MAX_VERTS], lightPath[MAX_VERTS];</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">int</span> nEye = GeneratePath(ray, eyePath, MAX_VERTS, scene);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;">/*</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// Hit of LightSource (not part of our scene)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (nEye == 0) </span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return L;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;">*/</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;">/*</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// Dont have such light source</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (lightPdf == 0.)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return Vec3f(0.);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;">*/</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">double</span> Le = lightWeight / lightPdf;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">int</span> nLight = GeneratePath(lightRay, lightPath, MAX_VERTS, scene);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green">// Connect bidirectional path prefixes and evaluate throughput</span></span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Vec3f directWt(1.);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">for</span> (i = 1; i &lt;= nEye; ++i)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green">// Handle direct lighting for bidirectional integrator</span></span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>directWt /= eyePath[i-1].relativeWeight;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Vec3f col = eyePath[i-1].material-&gt;GetColor( eyePath[i-1].u, eyePath[i-1].v, eyePath[i-1].point, eyePath[i-1].prim);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>L += directWt * col * scene-&gt;IlluminatePoint(eyePath[i-1].point, eyePath[i-1].normalGeometric) / WeightPath(eyePath, i, lightPath, 0);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>directWt *= eyePath[i-1].material-&gt;f(eyePath[i-1].dirIn, eyePath[i-1].dirOut) * col * fabs(Dot(eyePath[i-1].dirOut, eyePath[i-1].normalGeometric)) / eyePath[i-1].brdfWeight;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">for</span> (j = 1; j &lt;= nLight; ++j)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>L += Le * EvalPath(scene, eyePath, i, lightPath, j) / WeightPath(eyePath, i, lightPath, j);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">return</span> L;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;</span><span style="color: green">/**</span></span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp; </span>* Bi Directional Pathtracing for entiere scene</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp; </span>* Return the shaded color of the ray (pixel) or the bgColor if ray </span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp; </span>* do not intersect any object in the scene.</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp; </span>* @param ray Ray to trace through the scene</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; color: green; font-family: &#39;Courier New&#39;;"><span>&nbsp; </span>**/</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">Vec3f BiDirectionalPathTracing(Ray&amp; ray)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green">// reset total licght soucres lightning power (may be changed due to animation)</span></span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>totalLightsPower = 0;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">unsigned</span> <span style="color: blue">int</span> i;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">unsigned</span> <span style="color: blue">int</span> noOfLights = (<span style="color: blue">unsigned</span> <span style="color: blue">int</span>) mLights.size();</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp; </span><span style="color: blue">for</span> (i = 0; i &lt; noOfLights; ++i)</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green">// aproximation by intensity vector length - ok for white light...</span></span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>totalLightsPower += Length(mLights[i]-&gt;GetSourcePower());</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Ray lightRay;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">double</span> lightPdf, lightWeight;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Light * randomLight = GetRandomLight(&amp;lightPdf, &amp;lightWeight);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green">// we have randomly selected light source with probability equeal to its power</span></span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: green">/* double weight = */</span> randomLight-&gt;GetSample(lightRay);</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;">&nbsp;</span></p>
<p style="margin: 0 0 0;"><span style="font-size: 8pt; font-family: &#39;Courier New&#39;;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">return</span> Li( <span style="color: blue">this</span>, ray, lightRay, lightPdf, lightWeight);</span></p>
<p style="margin: 0 0 0"><span style="font-size: 8pt; line-height: 115%; font-family: &#39;Courier New&#39;;">}</span></p>
</div></div>
  
  <div><span id="spanReferences">References:</span></div>
 
 <div id="divReferences">
      <ul>
        <li><b>Bidirectional Path Tracing</b> <a href="http://www.graphics.cornell.edu/~eric/Portugal.html">(Eric P. Lafortune, Yves D. Willems)</a><br></li>
        <li><b>Robust Monte Carlo Methods for Light Transport Simulation</b> <a href="http://graphics.stanford.edu/papers/veach_thesis/">(Eric Veach, Ph.D. dissertation)</a></li>
        <li><a href="http://cgg.ms.mff.cuni.cz/lectures/pgr010.en.html">Computer Graphics III (Josef Pelik√°n MFF UK Prague)</a></li>
      </ul>
  </div>


  </div>
  </form>


</body></html>